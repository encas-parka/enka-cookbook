{{ define "main" }}

<script src="{{ .Site.BaseURL }}/flatpickr/flatpickr.js"></script>
<link rel="stylesheet" href="{{ "flatpickr/flatpickr.css" | relURL }}">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no, minimal-ui"> 

<iframe id="print-iframe" width="0" height="0"></iframe> {{/* USELESS  ? git-comment ? */}}

<!--::: Liste qui contiendra tous les ingrédients avec leurs données associés (quantité, recette, date, assietes...). Sert aux tableaux des quantités.  -->
{{- $IngredientList := slice -}}

<!-- Liste qui contiendra qui contient les listes de recettes pour chaque date -->
{{- $recettesList := slice -}}

{{- $IngredientsNamesList := slice -}}

{{- $IngredientsTypesList := slice -}}
{{- $recettesAll :=  dict -}}
{{$recetteKey:= 1}}

{{/*  Reccuperation des ingredients frais  */}}
{{ $pFrais := slice }}
{{- range $.Site.Data.ingredients -}}
  {{- range .ingredients -}}
    {{- if .pFrais -}}
      {{$pFrais =  $pFrais | append .title}}
    {{- end -}}
  {{- end -}}
{{- end -}}

{{- range $.Param "repas" -}}
  <!-- Creation des variables qui ne seront plus visible au prochain scope. Nous sommes dans les params de l'Evenement -->
  {{- $dateService:=.date_service -}}
  {{- $horaire:=.horaire -}}
  
  {{/*  Modifier l'heure de la date ISO en fonction du parametre $horaire (non défini par l'utilisateur) afin de permettre le tri par date des recettes.  */}}
    {{ if eq $horaire "matin" }}
      {{ $dateService = $dateService | replaceRE "T\\d{2}:\\d{2}:\\d{2}" "T08:00:00" }}
    {{ else if eq $horaire "midi" }}
      {{ $dateService = $dateService | replaceRE "T\\d{2}:\\d{2}:\\d{2}" "T12:00:00" }}
    {{ else if eq $horaire "soir" }}
      {{ $dateService = $dateService | replaceRE "T\\d{2}:\\d{2}:\\d{2}" "T20:00:00" }}
    {{ end }}
    
    {{- $assiettes:= (int .assiettes)  -}}


  <!--  -->
  {{- range .recettes_du_repas -}}
  <!--::: Creation des variables qui ne seront plus visible au prochain scope. Nous sommes dans les params de 1er niveau des recettes -->
    {{- $recette:=.recette -}}
    {{- $typePlat:=.type_plat -}}
    {{/*  Si un nombre de couverts alternatif a été déclaré pour ce plat en particulier, on substitue...  */}}
    {{ if .altAssiettes }}
      {{- $assiettes = .altAssiettes  -}}
    {{ end }}
    
    <!-- Envoie de la liste des recettes dans recettesList-->
            {{- $recettesList = $recettesList | append (dict
            "recetteKey" $recetteKey
            "recette" .recette
            "dateService" $dateService
            "horaire" $horaire
            "typePlat" $typePlat
            "assiettes" $assiettes
            "chef" .chef
            "commentaire" .commentaire
            "partof" .partof
            ) -}}
    {{/*  incrémentation des "id" unique des recettes  */}}
    {{$recetteKey = (add (float $recetteKey) 1)}}

    <!-- Reccupération des données sur les pages de chaque recettes -->
    {{- $url:= print .recette | urlize -}}
    {{- with site.GetPage $url -}}
    {{- $assiettesRecettes:= .Params.plate -}}
    <!-- pour tous les parametres ingredients... -->
      {{- range $key, $value := .Params.ingredients -}}
        <!-- ...on liste/boucle sur tous les sous parametres -->
        {{- range $index, $element := . -}}
        
        {{/*  On calcule les proportion de quantité : (quantité recette initiale x nombre d'assiettes pour le repas) / nombre de couvert de la recette initiale  */}}
        {{$quantiteCompute:= float "0" }}
        
        {{ if .quantite }}
          {{ $quantiteCompute = ((div (mul (float .quantite) (float $assiettes )) (float $assiettesRecettes ))) }}
        {{ end }}
        
        {{ $iType := ""}}
        {{ if and  (or (eq $key "lof") (eq $key "sucres") (eq $key "autres")) (in $pFrais .title) }}
        {{ $iType = "Frais"  }}
        {{ else }}
        {{ $iType = $key | strings.FirstUpper  }}
        {{ end }}

          {{- $IngredientList =
          $IngredientList | append (dict
           "ingredient" .title
          "quantite" $quantiteCompute
          "unit" .unit
          "ingType" $iType
          "recette" $recette
          "dateService" $dateService
          "horaire" $horaire
          "typePlat" $typePlat
          "assiettesRecettes" $assiettesRecettes
          "assiettes" $assiettes
          ) -}}

          {{ if and  (eq $key "lof") (in $pFrais .title) }}
            {{ $iType = "Frais"  }}
            {{- $IngredientsTypesList = $IngredientsTypesList | append (dict  "iType" $iType)  -}}
          {{ else }}
           {{- $IngredientsTypesList = $IngredientsTypesList | append (dict  "iType" ($key | strings.FirstUpper ))  -}}
          {{ end }}

        {{- end -}}
      {{- end -}}
      
      {{- end -}} {{/* {{ with site.GetPage $url }} */}}
      {{- end -}} {{/* recettes_du_repas */}}
      {{$recetteKey = (add (int $recetteKey) 1)}}
{{- end -}} {{/* range $.param repas */}}



{{/*  Dédoublage des listes  */}}
{{- $IngredientsNamesList = $IngredientsNamesList |uniq -}}
{{- $IngredientsTypesList = $IngredientsTypesList | uniq -}}

{{/* TODO .mettre dans un partial ?  ET c'est dans une boucle !?*/}}

{{/* ::: Regroupement des ingredients allergenes  */}}

{{/*  Reccupération des données allergenesIng sur chaque ingrédients. Permet de faire évoluer la liste plutot que de la figer  */}}
{{- $allergenesTypeList := slice -}}
{{ range $.Site.Data.ingredients }}
  {{- range .ingredients -}}
    {{- if .alergenesIng -}}
      {{- $allergenesTypeList = $allergenesTypeList | append .alergenesIng -}}
    {{- end -}}
  {{- end -}}
  {{ end }}
{{- $allergenesTypeList = $allergenesTypeList | uniq -}}

{{ $sAllergenes := newScratch }}
{{- range $.Site.Data.ingredients -}}
  {{- range .ingredients -}}
    {{- if .alergenesIng -}}
      {{- $ingTitle := .title -}}
      {{ range .alergenesIng -}}
           {{$sAllergenes.Add . (slice $ingTitle)}}
      {{ end }}    
    {{- end -}}
  {{- end -}}
{{- end -}}

{{ $allergenesDict := dict }}
{{ $allergenesList := slice }}
{{ range $allergenesTypeList }}
  {{ $allergenesDict = merge $allergenesDict (dict . ($sAllergenes.Get .)) }}
  {{ $allergenesList = append  ($sAllergenes.Get .) $allergenesList }}
{{ end }}

{{ $allergenesLgList := slice "Poisson" "Oeuf" "Soja" "Sésame" "Moutarde" "Fruit à coque" "Céleri" "Crustacé" "Arachide" "Mollusque"}}

<div id="app">
{{/*  lien vers le CMS de la page  */}}
  {{ $linkCMSPage := (path.Join "/admin/#/collections/evenement/entries/" (.Title | urlize)) }}
  <span class="text-end no-print p-2"><a target="_blank" rel="noopener noreferrer" href="{{$linkCMSPage}}/index">Modifier</a></span>



{{/* ::: navbar page */}}
<div class="position-sticky top-0 z-9 no-print">
  <nav class="navbar navbar-expand-md navbar-light bg-light shadow py-2  rounded-bottom-4 border border-2 ">
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarEvent"
      aria-controls="navbarEvent" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarEvent">
      <ul class="navbar-nav">
        <li class="nav-item p-1">
          <a href="#Recettes" class="btn btn-primary shadow-sm"
          >Recettes</a>
        </li>
        <li class="nav-item p-1">
          <a href="#TotalIngredients" class="btn btn-primary shadow-sm"
            >Ingrédients</a>
        </li>
      </ul>
      <ul class="navbar-nav ms-auto">
        <li class="nav-item p-1">
          <button class="btn btn-primary shadow-sm" data-bs-toggle="modal"  data-bs-target="#modalImpression"
          aria-controls="modalImpression"
          @click="printGlobal"  
            >
            Impression / PDF
          </button>
        </li>
      </ul>
    </div>
  </nav>
</div>

{{/*  ::: Impression - MODAL  */}}
<div class="modal modal-lg fade d-print-none" tabindex="-1" id="modalImpression" aria-labelledby="modalImpressionLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable ">
    <div class=" modal-content" >
      <div class="modal-header">
        <h5 class="modal-title fs-5" id="modalImpressionLabel">Imprimer / exporter en PDF</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">

        <div class="row">
          <div class="col">
            <div class="form-check">
              <input class="form-check-input" type="checkbox"
              v-model="toPrint.recettesSection"
              name="cbPrintRecettes" id="cb-printRecettes">
              <label class="form-check-label" for="cb-printRecettes">Imprimer les Recettes</label>
                </div>
            </div>
            </div>
        <hr>
        
      <div class="row">
        <div class="col-auto">
        
           <div class="form-check">
             <input
             class="form-check-input"
             type="checkbox"
             v-model="toPrint.ingredients"
             :value="true"
             name="cb-ing"
             id="cb-printIngredient"
             >
             <label class="form-check-label"
             for="cb-printIngredient">Imprimer les listes des ingrédients</label>
           </div>
          

        <div v-show="toPrint.ingredients" class="card card-body">
        

          <div class="form-check form-switch mb-3">
            <input class="form-check-input" type="checkbox" v-model="showAllColIngredients" id="checkRecipeDetail">
            <label for="checkRecipeDetail">Afficher les recettes pour chaque ingrédient</label>
            <span class="small">Attention, provoque parfois des bug. bien vérifier que tous les tableaux voulu sont imprimés</span>
          </div>
              <span>Ajouter des colonnes aux tableaux : </span>
              <select v-model="printAddCol" class="form-select">
              <option value="0">0</option>
                <option value="1">1</option>
                <option value="2">2</option>
              </select>
        </div>
        </div></div>
 
      <hr>
      <div class="text-end">
        <a class="btn btn-primary btn-sm"  @click="print" role="button" data-bs-dismiss="modal">Imprimer !</a>
      </div>
      </div>
    </div>
  </div>
</div>

{{/*  ::: Warning : missing recipes  */}}
{{- range $.Param "repas" -}}
{{- range .recettes_du_repas -}}
{{- $recette:=.recette -}}
{{- $url:= print .recette | urlize -}}
  {{- with site.GetPage $url -}}
  {{else}}
        <div class="card border-danger border-3 my-3 p-2">
          <div class="card-body text-danger">
            <h5 class="card-title mt-1">Une des recettes de l'évenement n'existe plus !</h5>
            <p class="card-text">La recette <span class="fw-bolder">"{{- $recette -}}"</span> présente dans les menus de
              l'événement n'existe plus sur le site. Par conséquent, la page ne s'affichera pas correctement. </p>
            <p>La recette à peut être été supprimée, ou bien son titre à été modifié. Dans tous les cas, pour résoudre le
              problème, il faut modifier la page de l'événement pour remplacer la recette disparue (ou re-donner son titre
              antérieur a la recette)...</p>
          </div>
        </div>
{{- end -}}
{{- end -}}
{{- end -}}


{{/* ::: _LES RECETTES   */}}
<div id="recettesSection" :class="{'no-print' : !toPrint.recettesSection}">
  <h3 id="Recettes" class="no-print">Les {{len $recettesList}} recettes prévues pour l'événement "{{.Page.Title}}"</h3>
  <div class="col-3 ms-auto">
    <div class=" d-print-none p-2 ms-auto form-check form-switch">
      <input class="form-check-input" type="checkbox" role="switch" id="switchDetailDisplay" v-model="displayDetailsRecettes">
      <label for="switchDetailDisplay" class="form-check-label">Afficher les détails</label>
    </div>
  </div>

  {{/* ::: _sommaire */}}
    <div class="no-print">
      {{/* Variable permettant de vérifier si les recettes sont de la meme date et du meme horaire ou pas; pour gérer leur affichage / l'organisation des recettes */}}
      {{ $dateService := "none"}}
      {{ $horaire := "none" }}
      <div class="card p-4 m-2">
        <span class="fs-4">Sommaire</span>
      
        {{- range sort $recettesList ".dateService" -}}

        <div>

          {{ if and (ne (.dateService | time.Format "Monday 2 January ") $dateService) }}

            <a href="#{{ .dateService | time.Format "Monday 2 January" |urlize}}" class="fw-bolder">
              <slot name='{{.dateService | time.Format "Monday 2 January" | urlize}}'>{{.dateService | time.Format "Monday 2 January"}}</slot>
            </a>
          
          {{ end }}

          <div class="ms-5">
            <a href="#recetteID{{ .recetteKey }}">
              <slot name="{{ .recetteKey }}"></slot>{{.recette }} →<span class="small"> ({{.horaire}} - {{.typePlat}} - {{.assiettes}} couverts)</span></a>
            </a>
          </div>
        </div>

        {{/*  Actualiser la date apres le range  */}}
        {{ $dateService = (.dateService | time.Format "Monday 2 January ")}}

        {{end}} {{/*  range recettesList */}}
      </div>
    </div>


{{/*  ::: __Les intertitres jours  */}}
{{ range sort $recettesList ".dateService" }}
  <div class="no-print">
    {{ if and ( ne (.dateService | time.Format "Monday 2 January ") $dateService )}}
      <div class="h3 text-center card py-4 mx-6 bg-primary bg-opacity-10 fw-bolder"  id="{{.dateService | time.Format "Monday 2 January" |urlize}}">{{ .dateService | time.Format "Monday 2 January"}}</div>
    {{ end }}
    
    {{ if ne .horaire $horaire }}
      <div class="h4 text-center card py-3 mx-6 bg-light">{{ .horaire}} </div>
    {{ end }}
    
    {{ $dateService = (.dateService | time.Format "Monday 2 January ")}}
    {{ if eq (.dateService | time.Format "Monday 2 January ") $dateService }}
      {{ $horaire = .horaire }}
    {{ else }}
      {{ $horaire = "" }}
    {{ end }}
  </div>

{{/* ::: __LES RECETTES cards */}}
{{/* variable avant GetPage */}}
{{- $assiettes:= (int .assiettes) -}}
{{- $recette := .recette -}}
{{- $recetteKey := .recetteKey -}}
{{- $dateService := .dateService -}}
{{- $horaire := .horaire -}}
{{- $partof := .partof -}}
{{- $typePlat := .typePlat -}}
{{- $assiettes := .assiettes -}}
{{- $chef := .chef -}}



{{/* ::: ____A l'interieur de chaque url de post recettes inclue dans l'evenement */}}
{{- $url:= print .recette | urlize -}}
{{- with site.GetPage $url -}} 
<div 
  class="card break-after avoid-break-inside my-4 p-2 bg-light bg-opacity-25 print-enlarge"
  id="recetteID{{$recetteKey}}"
  :class="{ 'no-print': !toPrint.recetteID{{$recetteKey}} }"
  >
  <div class="card-body py-1 print-enlarge">
    <a class="btn btn-sm btn-outline-primary float-end no-print mx-1" 
    @click="printThis('recetteID{{$recetteKey}}', 'recettesSection')" 
    > {{ partial "inline-svg" (dict "src" "fonticons/printer"  "fs" 3) }} </a>
    <a class="btn btn-sm btn-outline-primary float-end no-print mx-1" 
    href="{{.RelPermalink}}"
    > {{ partial "inline-svg" (dict "src" "fonticons/box-arrow-in-right"  "fs" 3) }} </a>
    <div id="titreRecette" class="py-1h2 my-2">
      <div class="my-2 h2">{{ $recette }}
        {{ if $partof }}
        <span class="ms-3 fs-5">(pour : {{ $partof }})</span>
        {{ end }}
      </div>
    </div>

    <div id="topRecette" class="row">
      <div class="col">
        <div class="fw-semibold fs-5 "> {{ $dateService | time.Format "Monday 2 January "}} - {{ $horaire }} - {{
          $typePlat }}</div>
        <div class="">
          <div class="print-fs-4 print-bold">Nombre de couverts: {{ $assiettes }}</div>
          {{ if $chef }}
          <div>Référent•es: {{ $chef }} - </div>
          {{ end }}
        </div>
        <div>
            {{ if .Params.spécialité }}
            <div class="small">Spécialité : {{ .Params.spécialité }}</div>
            {{ end }}
        </div>
        
      </div>
 
      <div class="col text-end">
        <div class="mb-2">{{ partial "content/badge-recette.html" . }}</div>
        <div>
          {{ if .Params.materiel }}
          {{ range .Params.materiel }}
          <div class="badge bg-grey float-end me-1">{{ . }}</div>
          {{ end }}
          {{ end }}
        </div>
      </div>
     
 
     {{/*  ::: ___Alertes  */}}
      {{/*  initialisation des variables check */}}
      {{- $assiettesInit := .Params.plate -}}

      {{- $isCheck := false -}} {{- $checkfor := "" -}} {{- $checkYes := false -}}
      {{- $compareQuantite := slice -}}

      {{- $alertQuantite := false -}}
      {{ with .Param "checkfor" }}{{- $checkfor = (int .) -}} {{- end -}}
      {{ if eq .Params.check "Oui" }}{{- $isCheck = true -}}{{ end }}
      {{ if (or $isCheck $checkfor) }}
      {{ $checkYes = true }}
      {{ end }}

      {{/*  TODO Ajouter proportion fixe : checkAlwaysOk  */}}
      {{ if eq $checkYes false }}
      {{ if $checkfor }}
        {{ if and 
          (or (gt (div $assiettes 2) $checkfor ) (lt (mul $assiettes 2) $checkfor) )
          (or (gt (div $assiettes 2) $assiettesInit ) (lt (mul $assiettes 2) $assiettesInit) )
          -}}
        {{- $alertQuantite = true -}} {{- $compareQuantite = slice $checkfor $assiettesInit -}}
        {{end}}
      {{ else }}
        {{ if or (gt (div $assiettes 2) $assiettesInit ) (lt (mul $assiettes 2) $assiettesInit) }}
        {{- $alertQuantite = true -}} {{- $compareQuantite = $assiettesInit -}}
        {{- end -}}
      {{- end -}}
    {{- end -}}

      {{/* reccupération des ingredients warning de la recette  */}}

      {{ $ingredientsL := slice }}

      {{- range $key, $value := .Params.ingredients -}}
      {{- with . -}}
      {{- range $index, $element := . -}}
      {{ $ingredientsL = $ingredientsL | append .title}}
      {{- end }}
      {{- end -}} 
      {{- end -}}

      
    {{- $alertGluten := intersect $ingredientsL ($sAllergenes.Get "Gluten") -}}
        
    {{- $alertPorc := intersect $ingredientsL ($sAllergenes.Get "Porc") -}}
    
    {{- $alertLait := intersect $ingredientsL ($sAllergenes.Get "Produit laitier") -}}
    
    {{- $alertAutresAllergenes := slice -}}
    {{ range $allergenesLgList }}
      {{- $toAdd := intersect $ingredientsL ($sAllergenes.Get . ) -}}
      {{- $alertAutresAllergenes = $alertAutresAllergenes | append  $toAdd -}}
    {{ end }}
    
    {{/*  TODO ? → liste des type d'allergenes  */}}
    {{- $alertTypesIng := slice -}}
    {{ range $allergenesTypeList }}
      {{- $toAdd := intersect $ingredientsL ($sAllergenes.Get . ) -}}

      {{- $alertTypesIng = $alertTypesIng | append $toAdd -}}
      
    {{ end }}
    
    
      {{- $assiettesInit := .Params.plate -}}
      {{/*  alert noprint  */}}
        <div class="row justify-content-start mt-2 ">

       <hr class="my-1 no-print">
        {{ if $alertQuantite }}
        <div class="col-12 col-md-6 col-lg-6 col-xl-6 print-col-2 ">
          <div class="card border-danger shadow small px-4 card-body print-nocard">
            {{ if not $checkYes }}
            <div> {{ partial "inline-svg" (dict "src" "fonticons/exclamation-circle" "display" "inline" "fs" 4) }}
              Le nombre de couverts prévu est significativement différent de celui qui a été déclaré comme testé
              ({{$compareQuantite}}): les proportions
              sont peut-être à adapter pour certains ingrédients. </div>
            {{ end }}
          </div>
        </div>
        {{ end }}

      
        {{- with (or ( $alertAutresAllergenes ) ( $alertGluten) ( $alertLait) ( $alertPorc)) -}}
        <div class="col-12 col-md-6 col-lg-6 col-xl-6 print-col-2">
          <div class="card border-danger shadow small px-4 card-body print-nocard">
            {{- with $alertAutresAllergenes -}}
            <div> {{ partial "inline-svg" (dict "src" "fonticons/exclamation-triangle" "display" "inline" "fs" 3) }}
              Allergènes divers:
              <span class="fw-bold">{{ delimit $alertAutresAllergenes ", "}}</span>
            </div>
            {{- end -}}
            {{- with $alertGluten -}}
            <div>{{ partial "inline-svg" (dict "src" "fonticons/gluten" "display" "inline" "fs" 3) }}
              Gluten :
              <span class="fw-bold">{{ delimit $alertGluten ", "}}</span>
            </div>
            {{- end -}}
            {{- with $alertLait -}}
            <div>{{ partial "inline-svg" (dict "src" "fonticons/milk-box" "display" "inline" "fs" 3) }}
              Produits laitier :
              <span class="fw-bold">{{ delimit $alertLait ", "}}</span>
            </div>
            {{- end -}}
            {{- with $alertPorc -}}
            <div>{{ partial "inline-svg" (dict "src" "fonticons/no-vegan" "display" "inline" "fs" 3) }} Porc:
              <span class="fw-bold">{{ delimit $alertPorc ", "}}</span>
            </div>
            {{- end -}}
          </div>
        </div>
        {{- end -}} 
      </div>
       
      <hr class="my-1 printonly">
   

    </div> 
    {{ end }} {{/* with site.GetPage $url */}}


      
    {{/* :::  ___LES INGREDIENTS  */}}
    <div id="IngredientsEtPreparation-recette" class="row" v-show="displayDetailsRecettes">
      <div id="Ingredients-recette" class="col-md-4 print-col-30-100">
        <h5 class="text-center">Ingrédients</h5>
        
      {{/*  variable avant GetPage  */}}
        {{- $assiettes:= (int .assiettes)  -}}
        {{- $url:= print .recette | urlize -}}
        {{/*    */}}
     
      {{- with site.GetPage $url -}}
        
        {{/*  Reccupération de la variable .Params.plate avec le range suivant, pour pouvoir l'utiliser dans le calcul des quantités correspondant au nombre d'assiete du repas  */}}
        {{- $assiettesRecettes:= (int .Params.plate) -}}
        
        {{- range $key, $value := .Params.ingredients -}}
        {{ with . }}
        <div class="card my-2 p-2 " outlined>
          <div class="row">
            <div class="col">
              <span class="">{{ $key | strings.FirstUpper }} </span>
              
              {{ range $index, $element := . -}}
              <div class="small ps-2">

                  {{/* Pour obtenir les quantité correspondant au nombres d'assiettes indiquées */}}
                  <span class="fw-bold">{{ partial "components/ingredients" (dict "title" .title "alergene" $allergenesList)
                    }}</span>

                  {{ if .quantite }}
                  :
                  {{ $quantiteRepas := (float (div (mul (float .quantite) $assiettes ) $assiettesRecettes)) }}
                  {{/*  renommage des unités  */}}
                  {{ $unit := .unit }}
                  {{ if eq .unit "grammes" }}
                    {{ $unit = "gr."}}
                  {{ else if and (eq .unit "unité") (gt $quantiteRepas 1) }}
                    {{ $unit = "unités"}}
                  {{ else if and (eq .unit "litre") (gt $quantiteRepas 1) }}
                    {{ $unit = "litres" }}
                  {{ end }}
                    {{ if or (eq .unit "Kg") (eq .unit "litre") }}
                      {{ if lt $quantiteRepas 1}}
                        {{ mul $quantiteRepas 1000 | math.Round }} 
                        {{/* XXX Retester */}}
                        {{ if eq .unit "litre"}}
                          {{ printf "ml" }}
                        {{ else if eq .unit "Kg"}}
                          {{ printf "gr."}}
                        {{ end }}
                      {{ else }}
                        {{/*  Ne garder que 2 décimales, et les supprimer si = ",00 " */}}
                        {{ $quantiteRepas | lang.FormatNumber 2 | strings.TrimRight "0" | strings.TrimRight ","}} {{$unit}}
                      {{end}}

                    {{ else if  or (eq .unit "grammes") (eq .unit "ml")}}
                      {{/* BUG : les quantité ne s'affiche plus du tout a certain endroit (partout ou grammes et ml ?)    */}}
                      {{ if gt (math.Ceil $quantiteRepas) 999}}
                        {{ div $quantiteRepas 1000  | lang.FormatNumber 2 | strings.TrimRight "0" | strings.TrimRight ","}}
                        {{ if eq .unit "ml"}}
                          {{ printf "litres" }}
                        {{ else if eq .unit "grammes"}}
                          {{ printf "Kg"}}
                        {{ end }} 
                         
                      {{ else if lt $quantiteRepas 1}}
                        {{ $quantiteRepas | lang.FormatNumber 2 | strings.TrimRight "0" | strings.TrimRight ","}} {{$unit}}
                      {{ else }}
                        {{ math.Round $quantiteRepas }} {{$unit}}
                      {{end}}
                    
                    {{ else }}
                      {{ if gt $quantiteRepas 0.49 }}
                        {{ math.Round $quantiteRepas }} {{$unit}}
                       
                      {{ else }}
                        {{ $quantiteRepas | lang.FormatNumber 2 }}  {{$unit}}
                      {{ end }}
                    {{ end }}
                  {{ end }}
              </div>
              {{ end }}

            </div>
          </div>
        </div>
        {{ end }}
      {{ end }} {{/* range $key, $value := .Params.ingredients */}}
    </div>
          
      {{/* ::: ___PREPARATION  */}}
      <div class="col-md-8 print-col-70-100">
        <h5 class="text-center">Préparation</h5>
        <div class=" card card-body">
        {{ if .Params.preparation24h }}
         <div class="card border border-danger mb-4 p-3 " >
           <p class="fs-5 fw-bold text-center print-fs-medium" >A prévoir à l'avance !</p>
           <div>{{ .Params.preparation24h | markdownify }}</div>
        </div>
        {{ end }}
          {{ .Params.preparation | markdownify }}
        </div>
      </div>
  
      {{ range .Params.astuces }}
          <div class="col-md-5 card card-body m-2 small ">
            Astuce: {{ .astuce }}
          </div>
      {{ end }}

              {{else}}
              <div>
                Cette recette n'exite plus dans la base de donnée !
              </div>
    {{ end }} {{/* with site.GetPage $url */}}
    </div>

    {{ if .Params.commentaire }}
      <div class="card">
        <div class="card-body">
          <p> {{ partial "inline-svg" (dict "src" "fonticons/information-line" "display" "inline" "fs" 4) }} {{.}}
          </p>
        </div>
      </div>
    {{ end }} 
    


  </div>
</div>
{{/*  Incrementation en fin de range  pour un unique ID par recettes  */}}
{{$recetteKey = (add (float $recetteKey) 1)}}



{{ end }} {{/* recettes du repas ? */}}

</div>


<div class="py-5 no-print" id="TotalIngredients"><hr></div>
<div class="container-fluid " :class="{'no-print':!toPrint.ingredients}">
  <h3 class="no-print">Listes des {{ len $IngredientList }} Ingrédients présents dans les menus</h3>
  <div class="row justify-content-evenly">

    {{/*  ::: _Sidebar Total ingredients  */}}
    <nav class="col-md-4 col-lg-3 d-md-block bg-light sidebar mt-7 d-print-none">
      <div class="sticky-top" style="top: 10%">
    
        <div class="my-5">
         <div class="mb-3">
            <label class="mb-2">Selectionner la période  que vous souhaitez prendre en compte</label>
            <div class="mb-3">
              <input id="datepickerStart" class="flatpickr flatpickr-input form-control"
                type="text" readonly="readonly" placeholder="Date de début" v-model="startDateSelected"
                >
            </div>
            <div class="mb-3">
              <input id="datepickerEnd" class="flatpickr flatpickr-input form-control" type="text"
                readonly="readonly" placeholder="Date de fin" v-model="endDateSelected">
              </div>
              <div class="mb-3 text-end">
                <button class="btn btn-primary btn-sm shadow-sm text-white" @click="datesReset" type="button" id="btn-allDate">Toutes les dates</button>
              </div>
            </div>
            <hr>
            <div class="mb-3">
              Afficher les quantités des produits frais par périodes 
            </div>
            <div class="input-group mb-3">
              <input type="number" v-model="daysPerRange" class="form-control" min="1" max="9" @input="changeDateRanges"
              >
              <span class="input-group-text" id="basic-addon2">jours</span>
            </div>
            <div class="mb-1 form-check form-switch">
              <input type="checkbox" class="form-check-input" v-model="legumesByRanges" name="cb-legumesByRanges" id="cb-legumesByRanges">
              <label for="cb-legumesByRanges">... pour les fruits et legumes frais </label>
            </div>
            <div class="mb-1 form-check form-switch">
              <input type="checkbox" class="form-check-input" v-model="fraisByRanges" name="cb-fraisByRanges" id="cb-fraisByRanges">
              <label for="cb-fraisByRanges">... pour les autres produit frais (laitiers...)</label>
            </div>
            <div class="mb-1 form-check form-switch">
              <input type="checkbox" class="form-check-input" v-model="animauxByRanges" name="cb-animauxByRanges" id="cb-animauxByRanges">
              <label for="cb-animauxByRanges">... pour les viandes et poissons </label>
            </div>

            <hr>
            <div class="form-check form-switch mb-3">
              <input class="form-check-input" type="checkbox" v-model="showAllColIngredients" id="checkRecipeDetail">
              <label for="checkRecipeDetail">Afficher les recettes pour chaque ingrédient</label>
            </div>
            <div class="mb-3">
              <input type="text" v-model="search" class="form-control" placeholder="Rechercher un ingrédient">
            </div>
          </div>

        </div>
  
      </nav>
  
  {{/* ::: Total INGREDIENTS   */}}
  <div class="col  print-col-12 ms-3" >

    {{/* :::  __FraisByDayRange  */}}
    {{ $fraisByRanges := slice | append  (dict "idR" "LegumesRanges" "titleR" "Fruits Legumes Frais" "iType" "Legumes" "thisRange" "legumesByRanges") (dict "idR" "AnimauxRanges" "titleR" "Viandes/Poissons Frais" "iType" "Animaux" "thisRange" "animauxByRanges") (dict "idR" "FraisRanges" "titleR" "Autres produits Frais" "iType" "Frais" "thisRange" "fraisByRanges") }}

    {{ range $fraisByRanges }}
    
    <div id="{{.idR}}" class="">
      <template v-for="(range, index) in rangesDates">

      {{/*  :::___table Frais sans detail  */}}
        <div 
        v-show="{{.thisRange}}"
       
        class="card my-2 mb-lg-6 avoid-break-inside border-danger border-1 mb-3  print-nocard"
        :class="{'no-print':!toPrint.LegumesRanges }"
        :id="range[0]"
        >  {{/*  computeTotalQIFiltered('{{.iType}}', range[0], range[range.length -1] ).length > 0 &&   */}}
        <div class="card-body">
          <div class="no-print">
            <span class="fs-5"> {{.titleR}} du [[ range[0] ]] au [[range[range.length - 1] ]] </span>
            <div class="my-2 float-end">
              <a
                class="btn btn-outline-secondary btn-sm text-muted "
                role="button"
                @click="printThis('range', 'ingredients')"
                >{{ partial "inline-svg" (dict "src" "fonticons/printer"  "fs" 3) }}</a>
            </div>
          </div>
    
          <table class="table table-bordered-bottom table-responsive table-striped print-border-1 " > 
            {{/*  v-show="!showAllColIngredients"  */}}
            <thead>
              <tr>
                <th>{{.iType}}</th>
                <th class="text-end">Total</th>
                <th class="printonly" v-show="printAddCol === '1' || printAddCol ===  '2' "></th>
                <th class="printonly" v-show="printAddCol === '2' "></th>
              </tr>
            </thead>
            <tbody>
              {{/*  TODO : Optimisation : la fonction computeTotalQIFiltered() est appelé en boucle pour CHAQUE tableau.   */}}
              <template v-for="(totals, ingredient) in computeTotalQIFilteredND('{{ .iType }}', range[0], range[range.length -1])">
                <tr>
                <td>[[ingredient]]</td>
                <td class="text-end print-td-mw-15">
                  <template v-for="(quantite, index) in totals" >
                    <span v-if="quantite.unitTotal !== ''">[[Math.round(quantite.qTotal * 100 ) / 100]] [[quantite.unitTotal]]</span>
                    <span v-else class="small">... [[quantite.qTotal]] plats ([[quantite.totalAssiettes]] couverts)</span>
                    <span v-if="index !== totals.length - 1"> + </span>
                  </template>
                </td>
                <td v-show="printAddCol === '1' || printAddCol ===  '2' " class="printonly print-td-15"></td>
                <td v-show=" printAddCol ===  '2' " class="printonly print-td-15"></td>
              </tr>
              </template>
            </tbody>
          </table>
        </div>
      </div>



    {{/*  ::: ___table Frais Détaillé  */}}
    {{/*  BUG : totalsAndDetailIngredientsFiltered() semble sensible au datepicker   */}}
      <div 
        v-show="computeTotalQIFiltered('{{.iType}}', range[0], range[range.length -1] ).length > 0 && showAllColIngredients && {{.thisRange}}"
        class="card my-2 mb-lg-6 avoid-break-inside border-danger border-1 mb-3  print-nocard"
        :class="{'no-print':!toPrint.LegumesRanges }"
        :id="range[0]"
        >
        <div class="card-body">
          <div class="no-print">
            <span class="fs-5"> {{.titleR}} du [[ range[0] ]] au [[range[range.length - 1] ]] </span>
            <div class="my-2 float-end">
              <a
                class="btn btn-outline-secondary btn-sm text-muted "
                role="button"
                @click="printThis('range', 'ingredients')"
                >{{ partial "inline-svg" (dict "src" "fonticons/printer"  "fs" 3) }}</a>
            </div>
          </div>

          <table id="tableFraisDetail" class="table table-bordered table-responsive">
            <thead>
              <tr>
                <th>Ingredients {{.iType}} </th>
                <th class="text-center">Recettes</th>
                <th class="text-end">Total</th>
                <th class="printonly" v-show="printAddCol === '1' || printAddCol ===  '2' "></th>
                <th class="printonly" v-show="printAddCol === '2' "></th>
              </tr>
            </thead>

            <tbody>
              <tr v-for="item in totalsAndDetailIngredientsFiltered('{{ .iType }}', range[0], range[range.length - 1])"
                :class="{'table-secondary fw-bold': item.qTotal}"
                >
                <td :class="{'small text-muted': !item.qTotal}">[[item.ingredient]]</td>
                <td v-if="item.recette" class="small">
                  <span class="fw-bold">[[item.recette]]</span> le [[new Date (item.dateService).toISOString().substr(0, 10)]] /
                  [[item.horaire]] <br> pour [[item.assiettes]] couverts
                  <span class="fw-bold float-end" v-if="item.quantite && item.unit">[[item.quantite]] [[item.unit]]</span>
                </td>
                <td v-else></td>
                <td class="text-end">
                  <span>[[item.qTotal]] [[item.unitTotal]]</span>
                </td>
                <td v-show="printAddCol === '1' || printAddCol ===  '2' " class="printonly print-td-15" ></td>
                <td v-show=" printAddCol ===  '2' || printAddCol ===  '3' " class="printonly print-td-15" ></td>
              </tr>

            </tbody>
          </table>
          </div>
          </div>
        </template>
      </div>
    {{ end }}


    {{/*  Renommage des iType  */}}
    {{ range sort $IngredientsTypesList "iType" "desc"}}
      {{ $iTypeName := .iType }}
    {{ if eq .iType "Lof" }}
      {{ $iTypeName = "LOF (Lait Oeuf Farine Huile)" }}
    {{ else if  eq .iType "Animaux"}}
      {{ $iTypeName = "Viandes et Poissons" }}
    {{ end }}

    {{/*  ::: _ Card des tableau ingredients petit et grand  */}}
    <div 
      v-show="this.computeTotalQIFiltered('{{.iType}}').length > 0"
      class="card my-2 mb-lg-6 avoid-break-inside  mb-3 print-nocard"
      :class="{'no-print':!toPrint.{{.iType}} }"
      id="{{.iType}}"
      >
      <div class="card-body">
        <div class="no-print">
          <span class="fs-4"> {{$iTypeName}} </span>
          <div class="my-2 float-end">
            <a
              class="btn btn-outline-secondary btn-sm text-muted "
              role="button"
              @click="printThis('{{.iType}}', 'ingredients')"
              >{{ partial "inline-svg" (dict "src" "fonticons/printer"  "fs" 3) }}</a>
          </div>
        </div>
        <div v-if="startDate !== startDateSelected || endDate !== endDateSelected" class="fs-6 text-center">
            Du [[new Date (startDateSelected).toLocaleDateString("fr-FR", {weekday: 'long', month: 'long', day:
            'numeric'})]] au [[new Date (endDateSelected).toLocaleDateString("fr-FR", {weekday: 'long', month: 'long',
            day: 'numeric'})]]
        </div>
  
  
        {{/* ::: __Table détaillé des ingrédients   */}}
        <table class="table table-bordered table-responsive" v-if="showAllColIngredients">
          <thead>
            <tr>
              <th>Ingredients {{.iType}} </th>
              <th class="text-center">Recettes</th>
              <th class="text-end">Total</th>
              <th class="printonly" v-show="printAddCol === '1' || printAddCol ===  '2' "></th>
              <th class="printonly" v-show="printAddCol === '2' "></th>
            </tr>
          </thead>

          <tbody>
            <tr v-for="item in totalsAndDetailIngredientsFiltered('{{ .iType }}', 'ingredients')"
              :class="{'table-secondary fw-bold': item.qTotal}"
              >
              <td :class="{'small text-muted': !item.qTotal}">[[item.ingredient]]</td>
              <td v-if="item.recette" class="small">
                <span class="fw-bold">[[item.recette]]</span> le [[new Date (item.dateService).toISOString().substr(0, 10)]] /
                [[item.horaire]] <br> pour [[item.assiettes]] couverts
                <span class="fw-bold float-end" v-if="item.quantite && item.unit">[[item.quantite]] [[item.unit]]</span>
              </td>
              <td v-else></td>
              <td class="text-end">
                <span>[[item.qTotal]] [[item.unitTotal]]</span>
              </td>
              <td v-show="printAddCol === '1' || printAddCol ===  '2' " class="printonly print-td-15" ></td>
              <td v-show=" printAddCol ===  '2' || printAddCol ===  '3' " class="printonly print-td-15" ></td>
            </tr>
          </tbody>
        </table>
        

        {{/* ::: __Table Sans Details des ingredients */}}
        <table class="table table-bordered-bottom table-responsive table-striped print-border-1 " v-if="!showAllColIngredients">
          <thead>
            <tr>
              <th>Ingredients {{$iTypeName}}</th>
              <th class="text-end">Total</th>
              {{/*  ajout optionnel des colonnes aux tableaux pour les impressions  */}}
              <th class="printonly" v-show="printAddCol === '1' || printAddCol ===  '2' "></th>
              <th class="printonly" v-show="printAddCol === '2' "></th>
            </tr>
          </thead>
          <tbody>
            {{/*  Itération sur tous les ingredients filtrés par type  */}}
            <template v-for="(totals, ingredient) in computeTotalQIFilteredND('{{ .iType }}')">
              <tr>
              <td>[[ingredient]]</td>
              <td class="text-end print-td-mw-15">
                <template v-for="(quantite, index) in totals" >
                  <span v-if="quantite.unitTotal !== ''">[[Math.round(quantite.qTotal * 100 ) / 100]] [[quantite.unitTotal]]</span>
                  <span v-else class="small">... [[quantite.qTotal]] plats ([[quantite.totalAssiettes]] couverts)</span>
                  <span v-if="index !== totals.length - 1"> + </span>
                </template>
              </td>
              <td v-show="printAddCol === '1' || printAddCol ===  '2' " class="printonly print-td-15"></td>
              <td v-show=" printAddCol ===  '2' " class="printonly print-td-15"></td>
            </tr>
            </template>
          </tbody>
        </table>
     
        {{/*  TEST table bak  */}}
      {{/*  <table class="table table-bordered-bottom table-responsive table-striped print-border-1 "   v-if="!showAllColIngredients">
          <thead>
            <tr>
              <th>Ingredients {{$iTypeName}}</th>
              <th class="text-end">Total</th>
              <th class="printonly" v-show="printAddCol === '1' || printAddCol ===  '2' "></th>
              <th class="printonly" v-show="printAddCol === '2' "></th>
            </tr>
          </thead>
          <tbody>
            <template v-for="(item, index) in computeTotalQIFiltered('{{ .iType }}')">
              <tr>
              <td>[[item.ingredient]]</td>
              
              <td class="text-end print-td-mw-15">
                  
                <span v-if="item.total.lenght === 0" class="small">? : [[item.total]] recettes</span>
                <span v-else>[[item.total]] [[item.unitTotal]]</span>
              
              </td>
              <td v-show="printAddCol === '1' || printAddCol ===  '2' " class="printonly print-td-15"></td>
              <td v-show=" printAddCol ===  '2' " class="printonly print-td-15"></td>
  
            </tr>
          </tbody>
        </table>  */}}
      </div>
    </div>

    {{ end }}
 
      </div>
    </div>
</div>
</div> 



<script nonce="6GwL6l4yhLQddbSv2ftKfX9sTqEkpYcmwyUPm5LEdgqF6VP27IUA5SLae8ScqZ171xC7gGVVZAOuYPJnsiUAzPadx4yFkdQ7GNHa" type="module">
  {{/*  ::: VueApp  */}}
  const app = new Vue ({
    delimiters: ['[[', ']]'],
    el: '#app',
    data () {
      return {
        search: '',
        selected: [], {{/* USELESS ? */}}
        datesRepas: [], // liste des dates entre 1er et dernier repas : pour les date marqué event dans le date-picker
        startDate: null, // re-initialisé dans mounted().
        endDate: null,
        startDateSelected: null,
        endDateSelected: null, 
        endDateSelectedDebug: null,
        endDateAllowed: null,
        startDateMenu: false,
        endDateMenu: false,
        showAllColIngredients: false, {{/* TEST */}}
        {{/*  ingredientsTypesList: [{{ print $IngredientsTypesList }}],  */}}
        displayDetailsRecettes: true,
        
        
        ingredientsRecettes: [
          {{ range $IngredientList }}
          {
            ingredient: "{{ .ingredient }}",
            ingredientType: "{{ .ingType }}",
            unit: "{{ .unit }}",
            quantite: {{ .quantite }},
            recette: "{{ .recette }}",
            dateService:'{{ .dateService }}',
            horaire: "{{ .horaire }}",
            typePlat: "{{ .typePlat }}",
            assiettesRecettes: {{ .assiettesRecettes }},
            assiettes: {{ .assiettes }},
          },
          {{ end }}
          ],

              
          totalsEachIngredientHeaders: [
          { text: 'Ingrédient', value: 'ingredient' },
          { text: 'par recette', value: 'recette'},
          { text: 'Quantité totale', value: 'total', align: 'right' },
          ],

        IngredientsRepasHeaders: [
          { text: "Ingredient", value: "name", filterable: true},
          { text: "", value: "ingredient", filterable: true},
          { text: "Recette", value: "recette"},
          { text: "quantité", align: "end", filterable: false, value: "quantite" },
          ], 

        

        {{/*  ::: ___Print parameters  */}}
        printSelectIng: false,
        toPrint: {
          recettesSection: true,
          ingredients: true,
          {{ range $IngredientsTypesList -}}
          {{.iType}}: true,
          {{ end -}}
          {{ range $recettesList -}}
            "recetteID{{.recetteKey}}": true,
          {{ end -}}
        },

        printAddCol: [],

        {{/*  printAffiches: false,  */}}

        IngredientsTypesList: [{{ range $IngredientsTypesList }} {{ .iType }}, {{ end }} ],
      
        rangesDates: [], // Tableau pour stocker les tranches de dates
        daysPerRange: 3,
        fraisByRanges: false,
        legumesByRanges: false,
        animauxByRanges: false,
        
        configDPStart: {
          enableTime: false,
          dateFormat: "Y-m-d",
          altInput: true,
          altFormat: "D d M",
        },


  } {{/* return */}}    
}, {{/* data */}}


{{/* ::: mounted */}}
mounted () {


  {{/*  ::: __date range  */}}
  datesRange: {
    // Trouver la première et la dernière date dans les données
    this.startDate = new Date(Math.min(
      ...this.ingredients.map(i => {
        return new Date(i.dateService);
      }),
      ),
    );
    this.endDate = new Date(Math.max(
      ...this.ingredients.map(i => {
        return new Date(i.dateService);
      }),
      ),
    );

    this.startDate = new Date(this.startDate).toISOString().substr(0, 10);
    this.endDate = new Date(this.endDate).toISOString().substr(0, 10);

    this.startDateSelected = this.startDate;
    this.endDateSelected = this.endDate
    // Derniere date autorisée dans la sélection (ne sera pas mutable puisque dans `mounted:`)
    this.endDateAllowed = this.endDateSelected;


  };

  datesRepasGen: {
    // Creer un tableau avec toutes les dateService, éliminer les doublon (Set). Défini le parametre `datesRepas` de `data()`, pour mettre en evidence les dateq où il y a des évenement dans les date-picker; TODO : est-ce encore utile maintenant que les `allowed-dates` fonctionne bien ? doublon ? Ne creer pas les date intermédiare si il y a des trou =>
    const dates = this.ingredients.map(i => {
      const datesFormat = i.dateService;
      return new Date(datesFormat).toISOString().substr(0, 10) // formatage
    });

    this.datesRepas = Array.from(new Set(dates)).sort(); 
  };

  rangeDateEvents: {
    this.splitDateRanges(this.daysPerRange);
  };

  endDateDebugGen: {
    /* Ajoute un jour a la endDateSelected, pour que les derniers jours soit bien pris en compte par le filtre opéré dans totalsIngredientFiltered.
    Meme fonction dans watch() pour la mise a jour en fonction de la selection dans le date-picker */
    const lastDateSelected = new Date(this.endDateSelected)
    this.endDateSelectedDebug = new Date(lastDateSelected.setDate(lastDateSelected.getDate() + 1 )).toISOString().substr(0, 10);
  };

  {{/*  ::: __flatpikr  */}}
  datePickerInit: {
    const datePicker = this.datePickerReset();
  };


}, // mounted() end

{{/*  :::Computed  */}}

computed: { 

  {{/*  #USELESS #TODO : faire le calcul en dure avec Hugo  → au moins pour le produit en croix*/}}
  ingredients: function () {
    return this.ingredientsRecettes.map(ingredient => {
      let quantite = this.roundQuantite(ingredient);
      return {
        ... ingredient,
        quantite: quantite,
      }
    });
  },


  {{/*  computeTotalQIFrais3Days: function (){
    const totalsIngredientFiltered = computeTotalQIFiltered(Frais)
  },  */}}


  
  


}, // computed end

{{/*  ::: watch  */}}
watch: {
  endDateSelected: function () {
    /* Ajoute un jour a la endDateSelected, pour que les derniers jours soit bien pris en compte par le filtre opéré dans totalsIngredientFiltered. 
    Meme fonction dans mounted() pour l'initialisation ! Doit etre dans watch() sinon les changement de endDateSelected ne sont pas pris en compte... */ 
    const lastDateSelected = new Date(this.endDateSelected)
    this.endDateSelectedDebug = new Date(lastDateSelected.setDate(lastDateSelected.getDate() + 1 )).toISOString().substr(0, 10);
  }, 

  {{/*  daysPerRange: 'splitDateRanges',  */}}
}, // watch() end

{{/*  ::: methods  */}}
methods: { 


  {{/*  ::: __print  */}}
  printThis(el, section) {
    this.$nextTick(() => {
      let printThat = [el, section];
      Object.keys(this.toPrint).forEach((param) => {
        if (!printThat.includes(param)) {
          this.toPrint[param] = false;
        } else {
          this.toPrint[param] = true;
        }
      });
      this.$nextTick(() => {
        window.print();
      });
    });
  },

  printGlobal() {

    Object.keys(this.toPrint).forEach((param) => {
      this.toPrint[param] = true;
    });
  },


  print() {
      setTimeout(() => {
        window.print();
      }, 500); 
  },

  {{/*  USELESS . C'est quoi ? Pas de reference  */}}
  updateSelectedAttribute (e) {
    let sel, i;

    sel = document.getElementById(e.target.id);
          // remove 'selected' from prior user selection
    for (i = 0; i < sel.length; i += 1) {
      sel[i].removeAttribute("selected");
    }
          // and add 'selected' to current selection
    sel[sel.selectedIndex].setAttribute("selected", "selected");
  },

  {{/*  :::__Date picker  */}}
  
  datesReset: function () {
    this.startDateSelected = this.startDate;
    this.endDateSelected = this.endDateAllowed;
    const datePickerReset = this.datePickerReset();
  },

  datePickerReset() {
 
    const configDPStart = {
      enableTime: false,
      dateFormat: "Y-m-d",
      altInput: true,
      altFormat: "D d M",
      defaultDate: this.startDate,
      minDate: this.startDate,
      maxDate: this.endDateAllowed,
    };
    const configDPEnd = {
      enableTime: false,
      dateFormat: "Y-m-d",
      altInput: true,
      altFormat: "D d M",
      defaultDate: this.endDateAllowed,
      minDate: this.startDate,
      maxDate: this.endDateAllowed,
    };
 
    flatpickr(datepickerStart, configDPStart);
    flatpickr(datepickerEnd, configDPEnd);   
   
  },

  DateAddDays(dateDebug) {
    dateDebug = new Date(dateDebug);
    dateDebug.setDate(dateDebug.getDate() + 1);
    return dateDebug;
  },

  roundQuantite: function (ingredient) {
    // Arrondir les quantité et convertir gr → Kg etc.. 
    {{/*  TODO : faire le calcul en dure avec Hugo  */}}
    let x = (Number(ingredient.quantite));
    if (typeof ingredient.quantite != "number") {
      ingredient.quantite = '-';
    } else if (ingredient.unit == "Kg" || ingredient.unit == "litre") {
      ingredient.quantite = Math.round(x * 100) / 100;
    } else if (ingredient.unit == "grammes") {
      ingredient.quantite = Math.round(x);
      if (ingredient.quantite > 1000) {
        ingredient.unit = "Kg"
        ingredient.quantite = ingredient.quantite / 1000      
      }
    } else {
      ingredient.quantite = Math.round(x * 100) / 100;
    }
    return ingredient.quantite;
  },

  convertToKg: function (quantite, unit) {
    return quantite / 1000;
  },

  {{/*  ::: __date split range   */}}

  changeDateRanges(){
    this.splitDateRanges(this.daysPerRange)
  },

  splitDateRanges(newDaysPerRange) {
    
    let currentRange = [];
    this.rangesDates = [];
    // split dates
    for (let i = 0; i < this.datesRepas.length; i++) {
      currentRange.push(this.datesRepas[i]);
      // push the current range
      if (currentRange.length >= Number(newDaysPerRange)) {
        this.rangesDates.push([...currentRange]);
        currentRange = [];
      }
    }
      // push the last range
      if (currentRange.length > 0) {
      this.rangesDates.push([...currentRange]);
    }
  },




  {{/* ::: __calculs des totaux des ingredients  */}}

  {{/*  tableaux des ingredients filtrés en fonction des dates séléctionné et types  */}}
  filteredIngredients: function (iType, start, end) {
    // Récupérer la liste des ingrédients
    let ingredients = this.ingredients

     // Si pas de valeurs definies, alors les dates sont celles du datepicker
    var start = start ?? this.startDateSelected ;
    var end = end ?? this.endDateSelectedDebug;
  
    // Filtrer les ingrédients selon les critères spécifiés
    const filtered = ingredients.filter(
      (i) =>
        i.ingredientType === iType &&
        i.dateService >= start &&
        i.dateService <=end &&
        i.ingredient.toLowerCase().includes(this.search.toLowerCase())
    );
    return filtered
  },


 {{/*  Totals des ingredients filtré ...  */}}
  computeTotalQIFiltered(iType, start, end) {
    
    // Debug de la date (ajout d'un jour pour que la derniere date soit prise en compte) → si 'end' est définie, alors on envoie à DateAddDays, puis on reformate la date. 
    const debugDate = end !== undefined ? this.DateAddDays(end) : undefined;
    const endDebug  = debugDate !== undefined ? debugDate.toISOString().slice(0, 10) : undefined;

    return this.computeTotalQI(this.filteredIngredients(iType, start, endDebug));
  },

  computeTotalQIFilteredND(iType, start, end) {
    // Debug de la date (ajout d'un jour pour que la derniere date soit prise en compte) → si 'end' est définie, alors on envoie à DateAddDays, puis on reformate la date. 
    const debugDate = end !== undefined ? this.DateAddDays(end) : undefined;
    const endDebug  = debugDate !== undefined ? debugDate.toISOString().slice(0, 10) : undefined;
    
    return this.computeTotalQuantite(this.filteredIngredients(iType, start, endDebug));
  },

  totalsAndDetailIngredientsFiltered(iType, start, end) {
    const total = this.computeTotalQI(this.filteredIngredients(iType));
    const element = this.filteredIngredients(iType);

    const result = new Set([...element, ...total].sort((a, b) => a.ingredient.localeCompare(b.ingredient)));

    return result;
  },

  computeTotalQI(filteredIng) {
  const totals = {};

  filteredIng.forEach((item) => {
    {{/*  TODO : optimisation  */}}
    if (item.unit === 'grammes') {
      item.quantite = item.quantite / 1000 ;
      item.unit = 'Kg';
    }
    if (item.unit === 'ml') {
      item.quantite = item.quantite / 1000 ;
      item.unit = 'litre';
    }
    const { ingredient, quantite, unit } = item;
    const key = `${ingredient}_${unit}`;
  
    if (!totals[key]) {
      totals[key] = {
          ingredient,
        unitTotal: unit,
        qTotal: quantite !== 0 ? quantite : 1
      };
      } else {
        totals[key].qTotal += quantite !== 0 ? quantite : 1;
    }
  });
  
    return Object.entries(totals).map(([key, { ingredient, unitTotal, qTotal, ...item }]) => {
      const [ingredientKey, unitKey] = key.split('_');
      return {
        ingredient,
        unitTotal,
        qTotal: Math.round(qTotal * 100) / 100,
        ...item
      };
    }).sort((a, b) => a.ingredient.localeCompare(b.ingredient));
  
  },

  computeTotalQuantite(filteredIng) {
    const finalTotals = {};

    filteredIng.forEach((item) => {
      if (item.unit === 'grammes') {
        item.quantite = item.quantite / 1000 ;
        item.unit = 'Kg';
      }
      if (item.unit === 'ml') {
        item.quantite = item.quantite / 1000 ;
        item.unit = 'litre';
      }
      const { ingredient, quantite, unit, assiettes } = item;
  
      if (!finalTotals[ingredient]) {
        finalTotals[ingredient] = [];
      }

      finalTotals[ingredient].totalAssiettes += assiettes;
      
      const existingItem = finalTotals[ingredient].find((item) => item.unitTotal === unit);
      if (existingItem) {
        existingItem.qTotal += quantite !== 0 ? quantite : 1;
        existingItem.totalAssiettes += assiettes;
      } else {
        finalTotals[ingredient].push({
          unitTotal: unit,
          qTotal: quantite !== 0 ? quantite : 1,
          totalAssiettes: assiettes,

        });
      }
    });
  
    const result = {};
  
    Object.keys(finalTotals).forEach((ingredient) => {
      result[ingredient] = finalTotals[ingredient].sort((a, b) => a.unitTotal.localeCompare(b.unitTotal));
    });
  
    return result;
  },

  {{/* TODO To computed ?  */}}
  ingredientTypeList () {
    return [...new Set (this.ingredients.map(ingredient => ingredient.ingredientType))];
  },

  {{/*  TODO pour print?__ ingredientsByRanges  */}}
  {{/*  fraisByRangesDays() {
    if (this.fraisByRanges  === "true") {
    this.legumesByRanges = true;
    this.animauxByRanges = "true";
    }
    else {
      this.legumesByRanges = "false";
      this.animauxByRanges = "false";
    
    }
  }  */}}

{{/*  USELESS ?
  filteredResultsCount(iType) {
    return this.totalsIngredientFiltered(iType, 'ingredients').length;
  },  */}}




  {{/*  datesAllowedRange: function (val) {
// retourne toutes les dates comprisent entre la premiere et la dernieres =>
    for(
      var datesAllowedArray=[],
      date=new Date(this.startDate); 
      date <= new Date(this.endDateAllowed); 
      date.setDate(date.getDate()+1)){
        datesAllowedArray.push(new Date(date).toISOString().substr(0, 10));
      }

    for (var i = 0; i < datesAllowedArray.length; i++) {
      if (datesAllowedArray[i] == val ){
        return val
      };
    }
  },  */}}


} {{/* fin de methods */}}
}); {{/* fin New Vue */}}


</script>








{{ end }}
